version: '2.1'
services:
  univaultoffice-documentserver:
    container_name: univaultoffice-documentserver
    build:
      context: ../.
    depends_on:
      - univaultoffice-statsd-exporter
    environment:
      - METRICS_ENABLED=${METRICS_ENABLED:-true}
      - METRICS_HOST=${METRICS_HOST:-univaultoffice-statsd-exporter}
      - METRICS_PORT=${METRICS_PORT:-9125}
      - METRICS_PREFIX=${METRICS_PREFIX:-ds.}
    stdin_open: true
    restart: always
    ports:
      - '80:80'

  univaultoffice-statsd-exporter:
    container_name: univaultoffice-statsd-exporter
    image: prom/statsd-exporter
    command: --statsd.event-flush-interval=30000ms
    ports:
      - '9102:9102'
      - '9125:9125/tcp'
      - '9125:9125/udp'

  univaultoffice-prometheus:
    container_name: univaultoffice-prometheus
    image: prom/prometheus
    ports:
      - '9090:9090'
    volumes:
      - ./prometheus/prometheus-scrape/statsd-exporter.yml:/etc/prometheus/prometheus.yml

  grafana:
    container_name: univaultoffice-grafana
    image: bitnami/grafana
    ports:
      - '3000:3000'
    environment:
      - 'GF_SECURITY_ADMIN_PASSWORD=G0pGE4'
    volumes:
      - ./prometheus/grafana/conf/prometheus.yml:/opt/bitnami/grafana/conf/provisioning/datasources/prometheus.yml
      - ./prometheus/grafana/conf/default-provider.yaml:/opt/bitnami/grafana/conf/provisioning/dashboards/default-provider.yaml
      - ./prometheus/grafana/dashboards:/opt/bitnami/grafana/dashboards
